<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="DavidChan,imchenway@gmail.com"><title>JVM类加载器与双亲委派模型（JDK8） · DavidChan's Blog</title><meta name="description" content="本文目录#




引言
JVM类加载器
什么是类加载器？
类与类加载器的关系
类加载器是如何去加载类的？
双亲委派模型
双亲委派模型工作过程
为什么需要双亲委派？
双亲委派是如何实现的？




本文总结
相关问题
如何破坏双亲委派模型？
为什么要破坏双亲委派模型？
有哪些破坏了双亲委派模型的例子"><meta name="keywords" content="DavidChan,imchenway"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/typography-override.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="shortcut icon" type="image/x-icon" href="https://tva1.sinaimg.cn/large/008eGmZEly1gnzyi23j0yj300w00w077.jpg"><script>var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.type = 'text/javascript';hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?542ea8c4a9ce535736e775029b1fad26";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
})();
</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PJKTXDR70K"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-PJKTXDR70K');
</script><script async crossorigin="anonymous" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1946575658110055"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><h3 title=""><a href="/">DavidChan's Blog</a></h3><div class="description"><p>I hear and I forget. <br>I see and I remember. <br>I write and I understand.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/imchenway"><i class="fa fa-github"></i></a></li><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a target="_blank" rel="noopener" href="https://tva1.sinaimg.cn/large/008i3skNly1gs66t63obvj30ml0m7dhm.jpg"><i class="fa fa-wechat"></i></a></li><h3 title=""></h3><li><i class="fa fa-tag"></i><a class="tag" href="/categories/Java/" title="Java">Java </a><a class="tag" href="/categories/JVM/" title="JVM">JVM </a><a class="tag" href="/categories/Algorithms/" title="Algorithms">Algorithms </a><a class="tag" href="/categories/Java/Concurrency/" title="Concurrency">Concurrency </a><a class="tag" href="/categories/博客搭建/" title="博客搭建">博客搭建 </a><a class="tag" href="/tags/Java/" title="#Java">#Java </a><a class="tag" href="/tags/Concurrency/" title="#Concurrency">#Concurrency </a><a class="tag" href="/tags/JVM/" title="#JVM">#JVM </a><a class="tag" href="/tags/Algorithm/" title="#Algorithm">#Algorithm </a><a class="tag" href="/tags/JMM/" title="#JMM">#JMM </a><a class="tag" href="/tags/GC/" title="#GC">#GC </a><a class="tag" href="/tags/Memory/" title="#Memory">#Memory </a><a class="tag" href="/tags/Metaspace/" title="#Metaspace">#Metaspace </a><a class="tag" href="/tags/Observability/" title="#Observability">#Observability </a><a class="tag" href="/tags/DynamicProgramming/" title="#DynamicProgramming">#DynamicProgramming </a><a class="tag" href="/tags/NIO/" title="#NIO">#NIO </a><a class="tag" href="/tags/Profiling/" title="#Profiling">#Profiling </a><a class="tag" href="/tags/JIT/" title="#JIT">#JIT </a><a class="tag" href="/tags/DataStructure/" title="#DataStructure">#DataStructure </a><a class="tag" href="/tags/Graph/" title="#Graph">#Graph </a><a class="tag" href="/tags/JPMS/" title="#JPMS">#JPMS </a><a class="tag" href="/tags/Stream/" title="#Stream">#Stream </a><a class="tag" href="/tags/Spring/" title="#Spring">#Spring </a><a class="tag" href="/tags/Postmortem/" title="#Postmortem">#Postmortem </a><a class="tag" href="/tags/CaseStudy/" title="#CaseStudy">#CaseStudy </a><a class="tag" href="/tags/Security/" title="#Security">#Security </a><a class="tag" href="/tags/Resilience/" title="#Resilience">#Resilience </a><a class="tag" href="/tags/Reactive/" title="#Reactive">#Reactive </a><a class="tag" href="/tags/Troubleshooting/" title="#Troubleshooting">#Troubleshooting </a><a class="tag" href="/tags/Performance/" title="#Performance">#Performance </a><a class="tag" href="/tags/ComputationalGeometry/" title="#ComputationalGeometry">#ComputationalGeometry </a><a class="tag" href="/tags/Containers/" title="#Containers">#Containers </a><a class="tag" href="/tags/Testing/" title="#Testing">#Testing </a><a class="tag" href="/tags/HTTP/" title="#HTTP">#HTTP </a><a class="tag" href="/tags/SRE/" title="#SRE">#SRE </a><a class="tag" href="/tags/Reliability/" title="#Reliability">#Reliability </a><a class="tag" href="/tags/ChaosEngineering/" title="#ChaosEngineering">#ChaosEngineering </a><a class="tag" href="/tags/Tree/" title="#Tree">#Tree </a><a class="tag" href="/tags/Safepoint/" title="#Safepoint">#Safepoint </a><a class="tag" href="/tags/DevOps/" title="#DevOps">#DevOps </a><a class="tag" href="/tags/Release/" title="#Release">#Release </a><a class="tag" href="/tags/FeatureFlag/" title="#FeatureFlag">#FeatureFlag </a><a class="tag" href="/tags/CDS/" title="#CDS">#CDS </a><a class="tag" href="/tags/GraalVM/" title="#GraalVM">#GraalVM </a><a class="tag" href="/tags/Search/" title="#Search">#Search </a><a class="tag" href="/tags/Records/" title="#Records">#Records </a><a class="tag" href="/tags/Backpressure/" title="#Backpressure">#Backpressure </a><a class="tag" href="/tags/ZGC/" title="#ZGC">#ZGC </a><a class="tag" href="/tags/Language/" title="#Language">#Language </a><a class="tag" href="/tags/SLO/" title="#SLO">#SLO </a><a class="tag" href="/tags/VirtualThreads/" title="#VirtualThreads">#VirtualThreads </a><a class="tag" href="/tags/Tracing/" title="#Tracing">#Tracing </a><a class="tag" href="/tags/Logging/" title="#Logging">#Logging </a><a class="tag" href="/tags/FFT/" title="#FFT">#FFT </a><a class="tag" href="/tags/JFR/" title="#JFR">#JFR </a><a class="tag" href="/tags/Analytics/" title="#Analytics">#Analytics </a><a class="tag" href="/tags/Tuning/" title="#Tuning">#Tuning </a><a class="tag" href="/tags/Deployment/" title="#Deployment">#Deployment </a><a class="tag" href="/tags/NMT/" title="#NMT">#NMT </a><a class="tag" href="/tags/Kubernetes/" title="#Kubernetes">#Kubernetes </a><a class="tag" href="/tags/Polyglot/" title="#Polyglot">#Polyglot </a><a class="tag" href="/tags/OpenTelemetry/" title="#OpenTelemetry">#OpenTelemetry </a><a class="tag" href="/tags/VarHandle/" title="#VarHandle">#VarHandle </a><a class="tag" href="/tags/ServiceMesh/" title="#ServiceMesh">#ServiceMesh </a><a class="tag" href="/tags/Istio/" title="#Istio">#Istio </a><a class="tag" href="/tags/Database/" title="#Database">#Database </a><a class="tag" href="/tags/DateTime/" title="#DateTime">#DateTime </a><a class="tag" href="/tags/Automaton/" title="#Automaton">#Automaton </a><a class="tag" href="/tags/String/" title="#String">#String </a><a class="tag" href="/tags/Epsilon/" title="#Epsilon">#Epsilon </a><a class="tag" href="/tags/SealedClasses/" title="#SealedClasses">#SealedClasses </a><a class="tag" href="/tags/Debugging/" title="#Debugging">#Debugging </a><a class="tag" href="/tags/Flow/" title="#Flow">#Flow </a><a class="tag" href="/tags/Migration/" title="#Migration">#Migration </a><a class="tag" href="/tags/Shenandoah/" title="#Shenandoah">#Shenandoah </a><a class="tag" href="/tags/IncidentResponse/" title="#IncidentResponse">#IncidentResponse </a><a class="tag" href="/tags/Panama/" title="#Panama">#Panama </a><a class="tag" href="/tags/ForeignMemory/" title="#ForeignMemory">#ForeignMemory </a><a class="tag" href="/tags/LeetCode/" title="#LeetCode">#LeetCode </a><a class="tag" href="/tags/Container/" title="#Container">#Container </a><a class="tag" href="/tags/RPC/" title="#RPC">#RPC </a><a class="tag" href="/tags/Tools/" title="#Tools">#Tools </a><a class="tag" href="/tags/操作系统/" title="#操作系统">#操作系统 </a><a class="tag" href="/tags/MQ/" title="#MQ">#MQ </a><a class="tag" href="/tags/TPM/" title="#TPM">#TPM </a><a class="tag" href="/tags/AI/" title="#AI">#AI </a><a class="tag" href="/tags/vibe/" title="#vibe">#vibe </a><a class="tag" href="/tags/Hexo/" title="#Hexo">#Hexo </a><a class="tag" href="/tags/GitHubPages/" title="#GitHubPages">#GitHubPages </a></li></ul><div class="footer"><div class="p"> <span>© 2017 - 2041 </span><i class="fa fa-star"></i><span> imchenway</span></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><!--li--><!--  if is_current('about')--><!--    a.current(href="/about")= __('About')--><!--  else--><!--    a(href="/about")= __('About')--><li><a href="/guestbook">留言板</a></li></div><div class="information"><div class="lang-switch"><span class="lang-label">语言</span><a class="current" href="/">简体中文</a><a href="/en/">英文（English）</a><a href="/default/">languages.default</a></div><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>JVM类加载器与双亲委派模型（JDK8）</a></h3></div><div class="post-content"><h3><span id="ben-wen-mu-lu">本文目录</span><a href="#ben-wen-mu-lu" class="header-anchor">#</a></h3><div class="toc">

<!-- toc -->

<ul>
<li><a href="#yin-yan">引言</a></li>
<li><a href="#jvm-lei-jia-zai-qi">JVM类加载器</a><ul>
<li><a href="#shi-me-shi-lei-jia-zai-qi">什么是类加载器？</a></li>
<li><a href="#lei-yu-lei-jia-zai-qi-de-guan-xi">类与类加载器的关系</a></li>
<li><a href="#lei-jia-zai-qi-shi-ru-he-qu-jia-zai-lei-de">类加载器是如何去加载类的？</a><ul>
<li><a href="#shuang-qin-wei-pai-mo-xing">双亲委派模型</a></li>
<li><a href="#shuang-qin-wei-pai-mo-xing-gong-zuo-guo-cheng">双亲委派模型工作过程</a></li>
<li><a href="#wei-shi-me-xu-yao-shuang-qin-wei-pai">为什么需要双亲委派？</a></li>
<li><a href="#shuang-qin-wei-pai-shi-ru-he-shi-xian-de">双亲委派是如何实现的？</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ben-wen-zong-jie">本文总结</a></li>
<li><a href="#xiang-guan-wen-ti">相关问题</a><ul>
<li><a href="#ru-he-po-pi-shuang-qin-wei-pai-mo-xing">如何破坏双亲委派模型？</a></li>
<li><a href="#wei-shi-me-yao-po-pi-shuang-qin-wei-pai-mo-xing">为什么要破坏双亲委派模型？</a></li>
<li><a href="#you-na-xie-po-pi-liao-shuang-qin-wei-pai-mo-xing-de-li-zi-fen-bie-shi-wei-liao-shi-me-mu-de">有哪些破坏了双亲委派模型的例子？分别是为了什么目的？</a></li>
<li><a href="#tomcat-zhong-lei-jia-zai-qi-de-jia-gou-shi-zen-me-yang-de">Tomcat中类加载器的架构是怎么样的？</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

    
<h1><span id="yin-yan">引言</span><a href="#yin-yan" class="header-anchor">#</a></h1><blockquote>
<p>在上文<a target="_blank" rel="noopener" href="https://imchenway.com/2021/07/01/JVM-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">JVM-类加载机制</a>中，描述了在<code>java</code>命令执行后，JVM类加载的整个流程。</p>
<ul>
<li>在上文中可以看到ClassLoader在<code>java</code>命令执行后起到了承上启下的重要作用</li>
<li>那么JVM中的ClassLoader是如何运行的呢？本文将带你揭开它神秘的面纱</li>
</ul>
</blockquote>
<h1><span id="jvm-lei-jia-zai-qi">JVM类加载器</span><a href="#jvm-lei-jia-zai-qi" class="header-anchor">#</a></h1><h2><span id="shi-me-shi-lei-jia-zai-qi">什么是类加载器？</span><a href="#shi-me-shi-lei-jia-zai-qi" class="header-anchor">#</a></h2><p>虚拟机的设计团队把类加载阶段中的<code>通过类的全限定名去找到对应的Class文件</code>这个动作放到Java虚拟机的外部去实现，为了便于让应用程序自己决定如何去获取所需要的类，实现这个动作的代码模块就叫做“类加载器”。</p>
<h2><span id="lei-yu-lei-jia-zai-qi-de-guan-xi">类与类加载器的关系</span><a href="#lei-yu-lei-jia-zai-qi-de-guan-xi" class="header-anchor">#</a></h2><p>类加载器只用于类的加载动作，但是在我们的Java程序中起到的作用却不至于类的加载。在我们比较两个类是否相等时（<code>equals()</code>、<code>isInstance()</code>、关键字<code>instanceof</code>），即使两个类来源于同一个Class文件，被同一个虚拟机加载，当它们的类加载不同时，那么这两个类也会不相等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imchenway.classload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类加载器与类的关系</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> David Chan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021-07-02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoaderTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> name.substring(name.lastIndexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> getClass().getResourceAsStream(fileName);</span><br><span class="line">                <span class="keyword">if</span> (is == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[is.available()];</span><br><span class="line">                    is.read(b);</span><br><span class="line">                    <span class="keyword">return</span> defineClass(name, b, <span class="number">0</span>, b.length);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> classLoader.loadClass(<span class="string">&quot;com.imchenway.classload.ClassLoaderTest&quot;</span>).newInstance();</span><br><span class="line">        System.out.println(obj.getClass());</span><br><span class="line">        System.out.println(obj <span class="keyword">instanceof</span> com.imchenway.classload.ClassLoaderTest);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;ClassLoaderTest classLoader: &quot;</span> + ClassLoaderTest.class.getClassLoader().toString());</span><br><span class="line">        System.out.println(<span class="string">&quot;obj classLoader: &quot;</span> + obj.getClass().getClassLoader().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class com.imchenway.classload.ClassLoaderTest</span><br><span class="line">false</span><br><span class="line">ClassLoaderTest classLoader: jdk.internal.loader.ClassLoaders$AppClassLoader@55054057</span><br><span class="line">obj classLoader: com.imchenway.classload.ClassLoaderTest$1@6ff3c5b5</span><br></pre></td></tr></table></figure>
<p>由此可以看到，<code>ClassLoaderTest</code>在启动时由<code>jdk.internal.loader.ClassLoaders$AppClassLoader@55054057</code>所加载，而<code>obj</code>由<code>com.imchenway.classload.ClassLoaderTest$1@6ff3c5b5</code>所加载，所以<code>System.out.println(obj instanceof com.imchenway.classload.ClassLoaderTest);</code>这一行输出的结果为<code>false</code>，因为类的唯一性由是否是同一个类加载器和是否同一个字节码文件同时决定的。</p>
<h2><span id="lei-jia-zai-qi-shi-ru-he-qu-jia-zai-lei-de">类加载器是如何去加载类的？</span><a href="#lei-jia-zai-qi-shi-ru-he-qu-jia-zai-lei-de" class="header-anchor">#</a></h2><h3><span id="shuang-qin-wei-pai-mo-xing">双亲委派模型</span><a href="#shuang-qin-wei-pai-mo-xing" class="header-anchor">#</a></h3><ul>
<li>从Java虚拟机的角度来说，只存在两种不同的类加载器，一种是启动类加载器，使用C++实现，是虚拟机自身的一部分；另一种就是所有其他的类加载器，都是由Java实现的，全部都继承自抽象类<code>java.lang.ClassLoader</code>。</li>
<li>从Java开发人员的角度来说，类加载器主要分为：<ul>
<li>启动类加载器（BootStrap ClassLoader）：负责将存放于<code>&lt;JAVA_HOME&gt;\lib</code>目录中的，或者被<code>XbootClasspath</code>参数指定路径的类库加载到虚拟机内存中。</li>
<li>扩展类加载器（Extension ClassLoader）：负责将存放于<code>&lt;JAVA_HOME&gt;\lib\ext</code>目录中的，或者被<code>java.ext.dirs</code>系统变量所指定的类库。</li>
<li>应用程序类加载器（Application ClassLoader）：负责将用户类路径（classPath）上所指定的类库</li>
<li>除了以上三种类加载器外，我们还可以自定义类加载器。（TODO 如何使用自定义类加载器实现类加载？）</li>
</ul>
</li>
</ul>
<h3><span id="shuang-qin-wei-pai-mo-xing-gong-zuo-guo-cheng">双亲委派模型工作过程</span><a href="#shuang-qin-wei-pai-mo-xing-gong-zuo-guo-cheng" class="header-anchor">#</a></h3><img src="/images/posts/JVM/双亲委派模型.png" width="400px">

<p>当一个类加载器收到了类加载的请求时，首先是交给自己的父类加载器去加载，最终都会到达顶层的引导类加载器，当父类加载器反馈无法完成这个加载请求时，子加载器尝试自己去加载。</p>
<h3><span id="wei-shi-me-xu-yao-shuang-qin-wei-pai">为什么需要双亲委派？</span><a href="#wei-shi-me-xu-yao-shuang-qin-wei-pai" class="header-anchor">#</a></h3><ol>
<li>可以避免类的重复加载，当父加载器已经加载过某一个类时，子加载器就不会再重新加载这个类。</li>
<li>保证应用程序的安全性，防止核心API被篡改。<blockquote>
<p>在类与类加载器的关系中我们证明了一个类的唯一性由加载这个类的类加载器和类本身所决定，如果没有双亲委派机制存在的话，设想如果应⽤程序类加载器想要 加载⼀个有破坏性的<code>java.lang.System</code>类，双亲委派模型会⼀层层向上委派，最终委派给启动类加载器，而启动类加载器中检查到缓存中已经有了这个类，并不会再加载这个有破坏性的System类。</p>
</blockquote>
</li>
</ol>
<p>当然，实际上自定义包名<code>java</code>开头的类将无法加载成功<br><img src="/images/posts/JVM/preDefineClass.png" width="500px"></p>
<h3><span id="shuang-qin-wei-pai-shi-ru-he-shi-xian-de">双亲委派是如何实现的？</span><a href="#shuang-qin-wei-pai-shi-ru-he-shi-xian-de" class="header-anchor">#</a></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    c = findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                <span class="comment">// to find the class.</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                c = findClass(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>findLoadedClass(name);</code>判断该类是否已经加载，如果加载过，则使用缓存</li>
<li>如果加载器不为null，则继续调用父类加载器的<code>loadClass(String name, boolean resolve)</code>方法</li>
<li>如果加载器为null，说明当前为引导类加载器（bootstrapClassLoader），在<code>findBootstrapClassOrNull(name)</code>中调用本地方法（C++实现）</li>
</ol>
<h1><span id="ben-wen-zong-jie">本文总结</span><a href="#ben-wen-zong-jie" class="header-anchor">#</a></h1><ul>
<li>在类的加载阶段，Java虚拟机通过类加载器模块去实现<code>通过类的全限定名去找到对应的Class文件</code>，同时通过类加载器的唯一实例对象地址和字节码文件的相同来判定类的唯一性，正时因为这个特性，也让类加载机制可以拥有隔离性。</li>
<li>类加载的过程中，使用双亲委派机制来避免类的重复加载，同时也保障了核心类库API不被篡改。</li>
</ul>
<h1><span id="xiang-guan-wen-ti">相关问题</span><a href="#xiang-guan-wen-ti" class="header-anchor">#</a></h1><h3><span id="ru-he-po-pi-shuang-qin-wei-pai-mo-xing">如何破坏双亲委派模型？</span><a href="#ru-he-po-pi-shuang-qin-wei-pai-mo-xing" class="header-anchor">#</a></h3><p>破坏双亲委托模型，只需要在<code>loadClass(String name, boolean resolve)</code> 方法中，不调用父类加载器去加载类就可以了。</p>
<h3><span id="wei-shi-me-yao-po-pi-shuang-qin-wei-pai-mo-xing">为什么要破坏双亲委派模型？</span><a href="#wei-shi-me-yao-po-pi-shuang-qin-wei-pai-mo-xing" class="header-anchor">#</a></h3><p>由于<code>类的唯一性由是否是同一个类加载器和是否同一个字节码文件同时决定的</code>这一特性，可以为应用程序提供类库的隔离性。</p>
<h3><span id="you-na-xie-po-pi-liao-shuang-qin-wei-pai-mo-xing-de-li-zi-fen-bie-shi-wei-liao-shi-me-mu-de">有哪些破坏了双亲委派模型的例子？分别是为了什么目的？</span><a href="#you-na-xie-po-pi-liao-shuang-qin-wei-pai-mo-xing-de-li-zi-fen-bie-shi-wei-liao-shi-me-mu-de" class="header-anchor">#</a></h3><ol>
<li>Tomcat：我们经常会在一个Tomcat中部署多个应用程序，多个应用程序之前可能用着不同版本的类库，也可能共享着一部分类库。这个时候自定类加载器就可以派上用场了<ul>
<li>在Tomcat中主要用自定义类加载器解决以下几个问题：<ol>
<li>同一个Tomcat中，各个Web应用之前各自使用的Java类库要互相隔离</li>
<li>同一个Tomcat中，各个Web应用之间可以共享有共享的Java类库</li>
<li>为了使Tomcat不受web应用的影响，服务器的类库应该与应用程序的类库互相独立</li>
<li>使Tomcat支持热部署</li>
</ol>
</li>
</ul>
</li>
</ol>
<h3><span id="tomcat-zhong-lei-jia-zai-qi-de-jia-gou-shi-zen-me-yang-de">Tomcat中类加载器的架构是怎么样的？</span><a href="#tomcat-zhong-lei-jia-zai-qi-de-jia-gou-shi-zen-me-yang-de" class="header-anchor">#</a></h3><img src="/images/posts/JVM/Tomcat双亲委派模型.png" width="400px">

<ul>
<li>CommonClassLoader：Tomcat最基本的类加载器，加载路径中的Class对Tomcat本身和每个WebApp可见</li>
<li>CatalinaClassLoader：Tomcat的容器私有类加载器，加载路径中的Class对WebApp不可见</li>
<li>SharedClassLoader：Tomcat的共享类加载器，加载路径中的Class可以被每个WebApp可见，但是对Tomcat不可见</li>
<li>WebAppClassLoader：各个WebApp的私有类加载器，加载路径中的Class仅对当前WebApp可见</li>
</ul>
<blockquote>
<p>CommonClassLoader能加载的类都可以被<code>Catalina ClassLoader</code>和<code>SharedClassLoader</code>使用，从而实现了公有类库的共用，而<code>CatalinaClassLoader</code>和<code>Shared ClassLoader</code>自己能加载的类则与对方相互隔离。<br>WebAppClassLoader可以使用<code>SharedClassLoader</code>加载到的类，但各个<code>WebAppClassLoader</code>实例之间相互隔离。</p>
</blockquote>
<hr>
<p>本作品系原创，采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.≠0/deed.zh">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，转载请注明出处。</p>

<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"enable":true,"owner":"imchenway","repo":"imchenway.github.io","admin":"imchenway","clientID":"7026ab2c4cdadba4d342","clientSecret":"8e00dadc2db335285be4c861e53ee1bf9f8cc713","distractionFreeMode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-07-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/JVM/" title="#JVM">#JVM </a></div></div></div></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>